<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üåç Live Disaster Tracker</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet Map Library -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
      body {
        background: linear-gradient(120deg, #0f172a, #1e293b, #334155);
        color: white;
      }
      #map {
        height: 420px;
        border-radius: 12px;
        margin-top: 10px;
      }
      .leaflet-popup-content-wrapper {
        background: #1e293b;
        color: white;
        font-size: 14px;
      }
      .severity-line {
        height: 12px;
        border-radius: 6px;
        background: linear-gradient(90deg, green, yellow, red);
      }
    </style>
  </head>

  <body class="p-6">
    <h1 class="text-3xl font-bold text-center mb-6">
      üåê Live Disaster Tracker
    </h1>

    <div class="max-w-6xl mx-auto grid md:grid-cols-3 gap-6">
      <!-- Control Panel -->
      <section class="md:col-span-1 bg-white/10 rounded-xl p-5 shadow-lg">
        <h2 class="text-xl font-semibold mb-3">üìç Report / Detect Disaster</h2>

        <button
          id="liveLocationBtn"
          class="w-full px-4 py-2 bg-blue-600 rounded hover:bg-blue-700 mb-3"
        >
          Get My Live Location
        </button>

        <form id="disasterForm" class="space-y-3">
          <input
            id="disasterType"
            type="text"
            placeholder="Disaster type (Fire, Flood...)"
            class="w-full p-2 rounded bg-white/10 outline-none"
          />
          <input
            id="locationInput"
            type="text"
            placeholder="Enter city, area, or coordinates"
            class="w-full p-2 rounded bg-white/10 outline-none"
          />
          <button
            type="submit"
            class="w-full px-4 py-2 bg-red-600 rounded hover:bg-red-700"
          >
            üö® Mark Disaster
          </button>
        </form>

        <div class="mt-6">
          <h3 class="text-lg font-semibold mb-2">Active Alerts</h3>
          <div id="alerts" class="space-y-3 text-sm"></div>
        </div>
      </section>

      <!-- Map Section -->
      <section
        class="md:col-span-2 bg-white/10 rounded-xl p-3 shadow-lg relative"
      >
        <div id="map"></div>
        <div class="mt-4 severity-line"></div>
        <p class="text-center text-gray-300 text-sm mt-2">
          Green ‚Üí Safe | Yellow ‚Üí Moderate | Red ‚Üí Severe
        </p>
      </section>
    </div>

    <footer class="text-center text-sm text-gray-400 mt-6"></footer>

    <script>
      // Initialize Leaflet Map
      const map = L.map("map").setView([20.5937, 78.9629], 5);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "¬© OpenStreetMap contributors",
      }).addTo(map);

      let userMarker = null;

      // Function: Get live user location
      document
        .getElementById("liveLocationBtn")
        .addEventListener("click", () => {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (pos) => {
                const { latitude, longitude, accuracy } = pos.coords;
                const coords = [latitude, longitude];

                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.marker(coords)
                  .addTo(map)
                  .bindPopup(
                    `<b>üìç You are here</b><br>Lat: ${latitude.toFixed(
                      5
                    )}, Lng: ${longitude.toFixed(5)}<br>Accuracy: ¬±${Math.round(
                      accuracy
                    )} m`
                  );
                userMarker.openPopup();
                map.setView(coords, 13);
              },
              (err) => alert("Error getting location: " + err.message),
              { enableHighAccuracy: true }
            );
          } else {
            alert("Geolocation not supported by your browser.");
          }
        });

      // Function: Determine Severity
      function determineSeverity(type, location) {
        const text = (type + " " + location).toLowerCase();
        if (
          text.includes("fire") ||
          text.includes("explosion") ||
          text.includes("chemical")
        )
          return "High";
        if (
          text.includes("flood") ||
          text.includes("cyclone") ||
          text.includes("storm")
        )
          return "Medium";
        return "Low";
      }

      // Function: Severity Images
      function getSeverityImage(level) {
        switch (level) {
          case "High":
            return "https://i.imgur.com/hHiZDRu.png"; // red fire/explosion
          case "Medium":
            return "https://i.imgur.com/9pL0mJt.png"; // flood/storm
          default:
            return "https://i.imgur.com/3Kn7wTb.png"; // low/minor event
        }
      }

      // Handle disaster submission
      const form = document.getElementById("disasterForm");
      const alerts = document.getElementById("alerts");

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const type = document.getElementById("disasterType").value.trim();
        const loc = document.getElementById("locationInput").value.trim();

        if (!type || !loc) {
          alert("Please enter both fields!");
          return;
        }

        const severity = determineSeverity(type, loc);
        const image = getSeverityImage(severity);

        // Fetch coordinates using Nominatim API
        fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
            loc
          )}`
        )
          .then((res) => res.json())
          .then((data) => {
            if (!data.length) {
              alert("Location not found!");
              return;
            }

            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);

            const color =
              severity === "High"
                ? "red"
                : severity === "Medium"
                ? "orange"
                : "green";

            const marker = L.circleMarker([lat, lon], {
              color,
              fillColor: color,
              radius: 10,
              fillOpacity: 0.8,
            }).addTo(map);

            const currentTime = new Date().toLocaleString();

            marker.bindPopup(`
            <b>${type}</b><br>
            Location: ${loc}<br>
            <span style="color:${color};font-weight:bold">Severity: ${severity}</span><br>
            Lat: ${lat.toFixed(5)}, Lng: ${lon.toFixed(5)}<br>
            Time: ${currentTime}<br>
            <img src="${image}" alt="${severity}" width="120" style="margin-top:5px;border-radius:8px;">
          `);

            map.setView([lat, lon], 11);

            // Add to sidebar alert log
            const div = document.createElement("div");
            div.className =
              "p-3 rounded bg-white/10 border-l-4 " +
              (severity === "High"
                ? "border-red-500"
                : severity === "Medium"
                ? "border-yellow-400"
                : "border-green-400");

            div.innerHTML = `
            <b>${type}</b> at <i>${loc}</i><br>
            <span style="color:${color};font-weight:bold">${severity} Severity</span><br>
            <small>${currentTime}</small><br>
            <img src="${image}" alt="${severity}" class="mt-2 rounded" width="150">
          `;
            alerts.prepend(div);
          })
          .catch(() => alert("Error fetching location data."));
      });
    </script>
  </body>
</html>